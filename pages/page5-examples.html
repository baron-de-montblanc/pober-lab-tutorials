<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Examples for how to use the FHD/eppsilon pipeline on Oscar. Prepared for use by Brown University students in the Jonathan Pober lab.">
    <meta name="keywords" content="Pober, Jonathan Pober, Brown University, IDL, Oscar, CCV, FHD, eppsilon, Radio astronomy">
    <meta name="robots" content="index, follow">
    <title>FHD/eppsilon Examples</title>

    <script>
        if (window.location.hostname === "baron-de-montblanc.github.io") {
            document.write('<base href="/pober-lab-tutorials/">');
        } else {
            document.write('<base href="/">');
        }
    </script>
    
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/journal/bootstrap.min.css" integrity="sha384-QDSPDoVOoSWz2ypaRUidLmLYl4RyoBWI44iA5agn6jHegBxZkNqgm2eHb6yZ5bYs" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/index.css" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/rainbow.min.css" integrity="sha512-ohxc5OnaYpC+nn8t5pH3F9Fx4xjwE7bnFDN7qX3GWWIK70+ivPEYQejZQOV96YmurTP5IaqmxyFnXDIEHg7Vhw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B24QDV202D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B24QDV202D');
</script>

<body>
    
    <div id="header-container"></div> <!-- Header loads here -->
    
    <div class="container-fluid">
        <div class="row">
            
            <div class="col-12 col-lg-3 mb-0">
                <div class="custom-vertical-nav" id="navbar-template"></div> <!-- Navbar loads here -->
            </div>

            <div class="container mt-2 col-12 col-lg-6">

                <h1 class="mb-4">Examples</h1>

                <p>
                    There is a steep learning curve for running FHD/eppsilon, and for using IDL in general.
                    In fact, I have often heard Jonathan quote a colleague who described IDL as 
                    "user-hostile"! I have prepared some examples to hopefully help lessen this 
                    impression.
                </p>

                <p>
                    This tutorial assumes that you have access to the group's <span>shared</span> 
                    data folder on <a href="https://docs.ccv.brown.edu/oscar", target="_blank">Oscar</a>.
                </p>

                <h2 id="fhd-only-example">FHD - Basic</h2>

                <p>
                    First, we will create a simple calibration run for a single MWA observation. 
                    This will generate output "image cubes", which we will then be able to pass 
                    as inputs to <span>eppsilon</span>.
                </p>

                <p>
                    The data have already been downloaded for you. 
                    Start by navigating to the <span>fhd_eppsilon</span> folder I created in 
                    the group's <span>shared</span> data folder:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
$ cd /oscar/data/jpober/shared/Tutorials/fhd_eppsilon
                    </code></pre>
                </div>

                You should find a directory structure that looks like this:

                <ul class="list-unstyled tree-ul">
                    <li>
                        data
                        <ul class="list-unstyled tree-ul">
                            <li>1161700008.metafits</li>
                            <li>1161700008.uvfits</li>
                        </ul>
                    </li>
                    <li>
                        fhd_outputs
                    </li>
                    <li>
                        idl_wrappers
                        <ul class="list-unstyled tree-ul">
                            <li>fhd_basic.pro</li>
                        </ul>
                    </li>
                    <li>
                        shell_scripts
                    </li>
                    <li>
                        slurm_out
                    </li>
                </ul>

                <p>
                    There may be more files and directories in <span>fhd_eppsilon</span>, 
                    but these are the relevant ones for this tutorial.
                </p>

                <p>
                    The <span>uvfits</span> file is the raw MWA input data that we wish to calibrate. 
                    It was originally downloaded from 
                    <a href="https://asvo.mwatelescope.org/", target="_blank">ASVO</a> in raw 
                    MWA correlator FITS file format, via the "Visibility Download Job" option. For more 
                    information on downloading and/or converting data on ASVO, visit the 
                    <a href="pages/asvo1-create-account.html">Downloading MWA Data from ASVO</a> 
                    tutorial page. This raw data was then converted to the required <span>uvfits</span> 
                    format using <a href="https://pyuvdata.readthedocs.io/en/latest/", target="_blank"><span>pyuvdata</span></a>.
                    (<strong>NOTE:</strong> As of April 2025, downloading MWA data directly to <span>uvfits</span> format 
                    via ASVO's built-in converter is incompatible with FHD, and will NOT work. Please download the 
                    raw data first, and manually convert it to <span>uvfits</span> using <span>pyuvdata</span>.)
                </p>

                <p>
                    The <span>metafits</span> file is downloaded jointly along with the <span>uvfits</span>. 
                    It contains observation metadata (e.g. time-stamps, number of frequency channels, number 
                    of baselines), and is read in by <span>FHD</span> in order to determine whether certain
                    tiles need to be flagged. Just make sure your <span>uvfits</span> and <span>metafits</span> 
                    are in the same directory, and that they have the same observation ID in their file names.
                </p>

                <p>
                    Next, the <span>fhd_basic.pro</span> file defines the IDL procedure used for 
                    our basic calibration run. It contains the following:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">IDL</div>
                    <pre class="custom-code"><code class="language-autoit">
pro fhd_basic

    data_path        = '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/data/'
    output_directory = '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/'
    version          = 'fhd_basic'
    obs_id           = '1161700008'

    ;-- Determine vis_file_list
    vis_file_list = [data_path + string(obs_id) + '.uvfits']

    ;-- Directory setup
    fhd_file_list = fhd_path_setup(vis_file_list, version=version, output_directory=output_directory)
    healpix_path  = fhd_path_setup(output_dir=output_directory, subdir='Healpix', output_filename='Combined_obs', version=version)

    ; -- OPTIONAL: Add your own keywords here! These will override the keywords in eor_wrapper_defaults
    save_uvf=1

    ;-- Set EoR defaults
    eor_wrapper_defaults, extra
    fhd_depreciation_test, _Extra=extra

    ;-- This is the main FHD procedure
    general_obs, _extra=extra

end
                    </code></pre>
                </div>



                <p>
                    It starts by defining some keywords, such as the path to the input data, the desired 
                    output path, and the observation ID. If the specified output directory does not 
                    already exist, it will be automatically created on runtime. The <span>version</span> 
                    keyword specifies the name that will be used to create the output folder.
                </p>

                <p>
                    After this initial setup, it compiles the
                    <span>eor_wrapper_defaults</span> procedure, which is a part of the 
                    <a href="https://github.com/EoRImaging/pipeline_scripts#", target="_blank"><span>pipeline_scripts</span></a>
                    dependency. This procedure defines the default settings for all EoR observations. 
                    Keywords defined directly in the <span>fhd_basic.pro</span> script will override the defaults, 
                    such as the <span>save_uvf=1</span> we are setting here (for details on allowed keywords, see the
                     <a href="https://github.com/EoRImaging/FHD/blob/master/dictionary.md", target="_blank"><span>FHD</span> docs</a>).
                </p>

                <p>
                    Finally, the <span>general_obs</span> procedure launches the calibration run using 
                    all the defined keywords and parameters. That's it!
                </p>

                <p>
                    The next file we want to look at is <span>fhd_basic.sh</span>:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">bash</div>
                    <pre class="custom-code"><code class="language-bash">
#!/bin/bash

#SBATCH -J fhd_basic
#SBATCH -c 12
#SBATCH --mem=128G
#SBATCH --time=8:00:00
#SBATCH -o /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_basic-%j.out
#SBATCH -e /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_basic-%j.out
#SBATCH --account=jpober-condo

module load imagemagick
module load idl

idl -IDL_DEVICE ps -quiet -IDL_CPU_TPOOL_NTHREADS 12 -e fhd_basic

if [ $? -eq 0 ]
then
    echo "Finished"
    exit 0
else
    echo "Job Failed"
    exit 1
fi
                    </code></pre>
                </div>


                <p>
                    The script starts by defining some common SLURM arguments: job name is 
                    specified via <span>-J</span>, number of CPU cores and allocated memory via 
                    <span>-c</span> and <span>--mem</span>, maximum runtime via <span>--time</span>, 
                    output file locations for output and error logs via <span>-o</span> and <span>-e</span> 
                    (here I'm specifying that outputs and errors should be logged in the same file), and 
                    the account used for ressource allocation via <span>--account</span> (we have more ressources 
                    available in the <span>jpober-condo</span> than the Oscar defaults allow). Finally, we just 
                     load in the appropriate modules and
                     launch the <span>fhd_basic</span> procedure we just wrote via <span>idl</span>.
                </p>

                <p>
                    Note the crazy compute resources I asked for here. This is definitely overkill but these 
                    jobs are pretty resouce-intensive. You might want to play around with the number of 
                    cores, amount of memory, and amount of time allocated. This simple 
                    calibration job should take between two and three hours to complete.
                </p>

                <p>
                    To launch this job, simply open up a terminal on an Oscar login node, <span>cd</span> 
                    to the <span>fhd_eppsilon/shell_scripts</span> directory and run:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
[fhd_eppsilon/shell_scripts]$ sbatch fhd_basic.sh
                    </code></pre>
                </div>

                
                <div class="d-flex justify-content-between">
                    <p class="last-edit">Last edit: 2026-02-07</p>
                    <p class="last-edit">Author: Jade Ducharme</p>
                </div>

            </div>
            
            <div class="d-none d-lg-block col-lg-3"></div>
            </div>
        </div>
    </div>
    
    
</body>

<div id="footer-template"></div> <!-- Footer loads here -->

</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/bash.min.js" integrity="sha512-nQ9BQEzuov+Ry6EIH8ve7VKKdOG91Ix3SAQcFmOiBR5qG8sJONrph1InWTJOGjfP5QkSTSy4VnkEsPMoFYRsUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/shell.min.js" integrity="sha512-W4zfUSnG/iue7LUx5hV2wF+akM0hVh4afLk8Avl3reONnH2lF5wPrg/D0rMGWHgZE2d+4XTjG5EJWzkyegUd5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/autoit.min.js" integrity="sha512-IPjYZ/J8t6x31d/SARbULBpe6IjG7MbV51kipvGfCb8Lepy33XHEgerqSA5+HsBfCeLKT35oAPndgo6p2AzooQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="assets/js/load-templates.js"></script>
<script src="assets/js/copy-code.js"></script>
<script src="assets/js/page-navigation-buttons.js"></script>
