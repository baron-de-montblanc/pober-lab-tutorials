<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Examples for how to use the FHD/eppsilon pipeline on Oscar. Prepared for use by Brown University students in the Jonathan Pober lab.">
    <meta name="keywords" content="Pober, Jonathan Pober, Brown University, IDL, Oscar, CCV, FHD, eppsilon, Radio astronomy">
    <meta name="robots" content="index, follow">
    <title>FHD/eppsilon Examples</title>

    <script>
        if (window.location.hostname === "baron-de-montblanc.github.io") {
            document.write('<base href="/pober-lab-tutorials/">');
        } else {
            document.write('<base href="/">');
        }
    </script>
    
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/journal/bootstrap.min.css" integrity="sha384-QDSPDoVOoSWz2ypaRUidLmLYl4RyoBWI44iA5agn6jHegBxZkNqgm2eHb6yZ5bYs" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/index.css" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/rainbow.min.css" integrity="sha512-ohxc5OnaYpC+nn8t5pH3F9Fx4xjwE7bnFDN7qX3GWWIK70+ivPEYQejZQOV96YmurTP5IaqmxyFnXDIEHg7Vhw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B24QDV202D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B24QDV202D');
</script>

<body>
    
    <div id="header-container"></div> <!-- Header loads here -->
    
    <div class="container-fluid">
        <div class="row">
            
            <div class="col-12 col-lg-3 mb-0">
                <div class="custom-vertical-nav" id="navbar-template"></div> <!-- Navbar loads here -->
            </div>

            <div class="container mt-2 col-12 col-lg-6">

                <h1 class="mb-4">Examples</h1>

                <p>
                    There is a steep learning curve for running FHD/eppsilon, and for using IDL in general.
                    In fact, I have often heard Jonathan quote a colleague who described IDL as 
                    "user-hostile"! I have prepared some examples to hopefully help lessen this 
                    impression.
                </p>

                <p>
                    This tutorial assumes that you have access to the group's <span>shared</span> 
                    data folder on <a href="https://docs.ccv.brown.edu/oscar", target="_blank">Oscar</a>.
                </p>

                <h2 id="fhd-basic">FHD - Basic</h2>

                <p>
                    First, we will create a simple calibration run for a single MWA observation. 
                    This will generate output "image cubes", which we will then be able to pass 
                    as inputs to <span>eppsilon</span>.
                </p>

                <p>
                    The data have already been downloaded for you. 
                    Start by navigating to the <span>fhd_eppsilon</span> folder I created in 
                    the group's <span>shared</span> data folder:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
$ cd /oscar/data/jpober/shared/Tutorials/fhd_eppsilon
                    </code></pre>
                </div>

                You should find a directory structure that looks like this:

                <ul class="list-unstyled tree-ul">
                    <li>
                        data
                        <ul class="list-unstyled tree-ul">
                            <li>1161700008.metafits</li>
                            <li>1161700008.uvfits</li>
                        </ul>
                    </li>
                    <li>
                        fhd_outputs
                    </li>
                    <li>
                        idl_wrappers
                        <ul class="list-unstyled tree-ul">
                            <li>fhd_basic.pro</li>
                        </ul>
                    </li>
                    <li>
                        shell_scripts
                    </li>
                    <li>
                        slurm_out
                    </li>
                </ul>

                <p>
                    There may be more files and directories in <span>fhd_eppsilon</span>, 
                    but these are the relevant ones for this tutorial.
                </p>

                <p>
                    The <span>uvfits</span> file is the raw MWA input data that we wish to calibrate. 
                    It was originally downloaded from 
                    <a href="https://asvo.mwatelescope.org/", target="_blank">ASVO</a> in raw 
                    MWA correlator FITS file format, via the "Visibility Download Job" option. For more 
                    information on downloading and/or converting data on ASVO, visit the 
                    <a href="pages/asvo1-create-account.html">Downloading MWA Data from ASVO</a> 
                    tutorial page. This raw data was then converted to the required <span>uvfits</span> 
                    format using <a href="https://pyuvdata.readthedocs.io/en/latest/", target="_blank"><span>pyuvdata</span></a>.
                    (<strong>NOTE:</strong> As of April 2025, downloading MWA data directly to <span>uvfits</span> format 
                    via ASVO's built-in converter is incompatible with FHD, and will NOT work. Please download the 
                    raw data first, and manually convert it to <span>uvfits</span> using <span>pyuvdata</span>.)
                </p>

                <p>
                    The <span>metafits</span> file is downloaded jointly along with the <span>uvfits</span>. 
                    It contains observation metadata (e.g. time-stamps, number of frequency channels, number 
                    of baselines), and is read in by <span>FHD</span> in order to determine whether certain
                    tiles need to be flagged. Just make sure your <span>uvfits</span> and <span>metafits</span> 
                    are in the same directory, and that they have the same observation ID in their file names.
                </p>

                <p>
                    Next, the <span>fhd_basic.pro</span> file defines the IDL procedure used for 
                    our basic calibration run. It contains the following:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">IDL</div>
                    <pre class="custom-code"><code class="language-autoit">
pro fhd_basic

    data_path        = '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/data/'
    output_directory = '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/'
    version          = 'fhd_basic'
    obs_id           = '1161700008'

    ;-- Determine vis_file_list
    vis_file_list = [data_path + string(obs_id) + '.uvfits']

    ;-- Directory setup
    fhd_file_list = fhd_path_setup(vis_file_list, version=version, output_directory=output_directory)
    healpix_path  = fhd_path_setup(output_dir=output_directory, subdir='Healpix', output_filename='Combined_obs', version=version)

    ; -- OPTIONAL: Add your own keywords here! These will override the keywords in eor_wrapper_defaults
    save_uvf=1

    ;-- Set EoR defaults
    eor_wrapper_defaults, extra
    fhd_depreciation_test, _Extra=extra

    ;-- This is the main FHD procedure
    general_obs, _extra=extra

end
                    </code></pre>
                </div>



                <p>
                    It starts by defining some keywords, such as the path to the input data, the desired 
                    output path, and the observation ID. If the specified output directory does not 
                    already exist, it will be automatically created on runtime. The <span>version</span> 
                    keyword specifies the name that will be used to create the output folder.
                </p>

                <p>
                    After this initial setup, it compiles the
                    <span>eor_wrapper_defaults</span> procedure, which is a part of the 
                    <a href="https://github.com/EoRImaging/pipeline_scripts#", target="_blank"><span>pipeline_scripts</span></a>
                    dependency. This procedure defines the default settings for all EoR observations. 
                    Keywords defined directly in the <span>fhd_basic.pro</span> script will override the defaults, 
                    such as the <span>save_uvf=1</span> we are setting here (for details on allowed keywords, see the
                     <a href="https://github.com/EoRImaging/FHD/blob/master/dictionary.md", target="_blank"><span>FHD</span> docs</a>).
                </p>

                <p>
                    Finally, the <span>general_obs</span> procedure launches the calibration run using 
                    all the defined keywords and parameters. That's it!
                </p>

                <p>
                    The next file we want to look at is <span>fhd_basic.sh</span>:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">bash</div>
                    <pre class="custom-code"><code class="language-bash">
#!/bin/bash

#SBATCH -J fhd_basic
#SBATCH -c 12
#SBATCH --mem=128G
#SBATCH --time=8:00:00
#SBATCH -o /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_basic-%j.out
#SBATCH -e /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_basic-%j.out
#SBATCH --account=jpober-condo

module load imagemagick
module load idl

idl -IDL_DEVICE ps -quiet -IDL_CPU_TPOOL_NTHREADS 12 -e fhd_basic

if [ $? -eq 0 ]
then
    echo "Finished"
    exit 0
else
    echo "Job Failed"
    exit 1
fi
                    </code></pre>
                </div>


                <p>
                    The script starts by defining some common SLURM arguments: job name is 
                    specified via <span>-J</span>, number of CPU cores and allocated memory via 
                    <span>-c</span> and <span>--mem</span>, maximum runtime via <span>--time</span>, 
                    output file locations for output and error logs via <span>-o</span> and <span>-e</span> 
                    (here I'm specifying that outputs and errors should be logged in the same file), and 
                    the account used for ressource allocation via <span>--account</span> (we have more ressources 
                    available in the <span>jpober-condo</span> than the Oscar defaults allow). Finally, we just 
                     load in the appropriate modules and
                     launch the <span>fhd_basic</span> procedure we just wrote via <span>idl</span>.
                </p>

                <p>
                    Note the crazy compute resources I asked for here. This is definitely overkill but these 
                    jobs are pretty resouce-intensive. You might want to play around with the number of 
                    cores, amount of memory, and amount of time allocated. This simple 
                    calibration job should take between two and three hours to complete.
                </p>

                <p>
                    To launch this job, simply open up a terminal on an Oscar login node, <span>cd</span> 
                    to the <span>fhd_eppsilon/shell_scripts</span> directory and run:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
[fhd_eppsilon/shell_scripts]$ sbatch fhd_basic.sh
                    </code></pre>
                </div>


                <h2 id="fhd-advanced">FHD - Advanced</h2>

                <p>Let's move on to a more advanced example. In the
                     <span>/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/idl_wrappers</span> 
                     directory, you will find a file called <span>fhd_single_uvfits.pro</span>. 
                      This <span>IDL</span> wrapper contains the 
                    "optimal" set of <span>FHD</span> keywords, as of Feb. 2026:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">IDL</div>
                    <pre class="custom-code"><code class="language-autoit">
pro fhd_single_uvfits

    compile_opt strictarr

    ;-- Read command-line arguments
    args = Command_Line_Args(count=nargs)

    obs_idx          = args[0]  ; OBSID index in data_path
    data_path        = args[1]
    output_directory = args[2]
    version          = args[3]

    ;-- Determine vis_file_list using obs_idx as an index
    file_list = file_search(data_path + '*.uvfits', count=nfiles)
    if nfiles EQ 0 then message, 'No .uvfits files found in ' + data_path
    if long(obs_idx) GE nfiles then message, 'obs_idx out of bounds.'

    vis_file_list = [file_list[long(obs_idx)]]

    ;-- Directory setup
    fhd_file_list = fhd_path_setup(vis_file_list, version=version, output_directory=output_directory)
    healpix_path  = fhd_path_setup(output_dir=output_directory, subdir='Healpix', output_filename='Combined_obs', version=version)

    ; ================== Custom keywords go here --> These will override the keywords in eor_wrapper_defaults ================
    
    instrument                            = 'mwa2' ; MWA Phase II
    
    ; -- Catalog/model keywords
    calibration_catalog_file_path         = filepath('GLEAM_v2_plus_rlb2019.sav',root=rootdir('FHD'),subdir='catalog_data')
    calibration_subtract_sidelobe_catalog = filepath('GLEAM_v2_plus_rlb2019.sav',root=rootdir('FHD'),subdir='catalog_data')
    model_subtract_sidelobe_catalog       = filepath('GLEAM_v2_plus_rlb2019.sav',root=rootdir('FHD'),subdir='catalog_data')
    subtract_sidelobe_catalog             = filepath('GLEAM_v2_plus_rlb2019.sav',root=rootdir('FHD'),subdir='catalog_data')
    ALLOW_SIDELOBE_MODEL_SOURCES          = 1
    ALLOW_SIDELOBE_CAL_SOURCES            = 1
    diffuse_model                         = 0
    model_delay_filter                    = 1     ; Removes any higher k_tau power from the model
    
    ; -- Calibration keywords
    diffuse_calibrate                     = 0
    calibration_flux_threshold            = 0.1
    cal_time_average                      = 0
    cal_bp_transfer                       = 0
    max_cal_iter                          = 1000L
    cal_reflection_mode_theory            = 1
    cal_mode_fit                          = [90,150,230,320]
    use_adaptive_calibration_gain         = 1
    calibration_base_gain                 = 0.5
    auto_ratio_calibration                = 1
    calibration_auto_fit                  = 0
    no_calibration_frequency_flagging     = 0
    cal_stop                              = 0     ; if 1, code stops after calibration and does NOT produce Healpix cubes
    
    ; -- Other keywords
    restrict_hpx_inds                     = 'EoR0_high_healpix_inds_3x.idlsave'
    no_frequency_flagging                 = 0     ; Respect uvfits flags
    beam_clip_floor                       = 1
    FoV                                   = 0
    interpolate_kernel                    = 1
    beam_nfreq_avg                        = 1
    ps_kspan                              = 200.  ; Prevent power leakage by not gridding longer baselines
    n_avg                                 = 2     ; Average in frequency to 160kHz
    digital_gain_jump_polyfit             = 0
    dimension                             = 1024  ; For phase 2, larger default dimension is not necessary
    recalculate_all                       = 1     ; WARNING: will not read in sav files
    
    
    ; ===================================== End of custom keywords =================================================

    ;-- Set EoR defaults and bundle all the extra keywords into a structure
    eor_wrapper_defaults, extra
    fhd_depreciation_test, _Extra=extra

    print, ''
    print, 'Keywords set in wrapper:'
    print, structure_to_text(extra)
    print, ''

    ;-- This is the main FHD procedure
    general_obs, _extra=extra

end
                    </code></pre>
                </div>

                <p>
                    There is a lot more going on, but the structure is very similar. First, instead of hard-coding 
                    the observation ID and the data paths, this setup allows them to be read off from whatever process calls 
                    the wrapper. We will shortly look at the shell script that calls <span>idl</span> on this wrapper, and 
                    we will see that the observation ID and data paths are defined in that shell script. This makes it a lot 
                    easier to reuse this wrapper, instead of overwriting it each time with new arguments.
                </p>

                <p>
                    Next, the custom keywords. Detailed explanations for each of these keywords can be found in the 
                    <a href="https://github.com/EoRImaging/FHD/blob/master/dictionary.md" target="_blank"><span>FHD</span> documentation</a>, 
                    but I will briefly list a few important ones:
                </p>

                <ul>
                    <li>
                        <span>cal_stop</span>: If this is set to <span>1</span>, <span>FHD</span> will calibrate the 
                        data and terminate. It will NOT produce the <span>Healpix</span> cubes that are required for 
                        further processing in <span>eppsilon</span>. (Typically, you want it set to <span>0</span>.)
                    </li>
                    <li>
                        <span>no_frequency_flagging</span>: Set to <span>1</span> for MWA Phase III data, as it disables 
                        coarse-band flagging (in fact, I think it removes all flags, but I could be wrong). Should 
                        definitely be set to <span>0</span> for MWA Phase I and Phase II data.
                    </li>
                    <li>
                        <span>n_avg</span>: This one is super important. With years, the community has converged on 
                        preferring MWA power spectra to be averaged to an overall frequency resolution of 160khz.
                         <span>n_avg</span> specifies the number of adjacent frequency channels that should 
                        be averaged together during the processing. Whatever number you set here, make sure it evens out so 
                        that your final cubes have a frequency resolution of 160khz.
                    </li>
                    <li>
                        <span>recalculate_all</span>: If set to <span>0</span>, <span>FHD</span> will read in checkpoint 
                        <span>.sav</span> files on any subsequent run (the first run creates the <span>.sav</span> files 
                        automatically). If you want to force <span>FHD</span> to recalculate everything from scratch on 
                        every subsequent run, set this to <span>1</span>.
                    </li>
                </ul>

                <p>
                    Note that this procedure takes in an observation <i>index</i>, as opposed to an MWA observation ID. This 
                    is because I've specifically optimized this for array jobs. I did this because typically, when you run <span>FHD</span>, 
                    you need to run it on a LOT of data. This procedure makes it easy to define a global <span>data_path</span> that may contain 
                    hundreds of <span>uvfits</span> files, and then specifying the index of the desired file in that path. The top-level 
                    shell script controlling all of this can then trivially run an array job across all file indices.
                </p>

                <p>
                    Speaking of the top-level shell script, let's take a look at it. You will find it in 
                    <span>/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/shell_scripts/fhd_advanced.sh</span>:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">bash</div>
                    <pre class="custom-code"><code class="language-bash">
#!/bin/bash

#SBATCH -J fhd_advanced
#SBATCH -c 12
#SBATCH --mem=200G
#SBATCH --time=48:00:00
#SBATCH --account=jpober-condo

#SBATCH --array=0-2

# Use '%A' for array-job ID, '%J' for job ID and '%a' for task ID
#SBATCH -o /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_advanced-%A-%a.out
#SBATCH -e /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_advanced-%A-%a.out

module load imagemagick
module load idl

echo "Starting job $SLURM_ARRAY_TASK_ID on $HOSTNAME"

retry_delay=300  # seconds

while true; do
    echo "Attempting to start IDL..."
    output=$( idl \
        -IDL_DEVICE ps \
        -quiet \
        -IDL_CPU_TPOOL_NTHREADS 12 \
        -e fhd_single_uvfits \
        -args ${SLURM_ARRAY_TASK_ID} '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/data/' '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/' 'advanced'\
        2>&1 )
        
    status=$?
    echo "$output"
    
    if ! echo "$output" | grep -q "Failed to acquire license"; then
        echo "License successfully aquired. Job ended with status $status."
        break
    else
        echo "IDL license unavailable. Retrying in $retry_delay seconds..."
        sleep $retry_delay
    fi

done
                    </code></pre>
                </div>


                <p>
                    There are a few major differences between this script and the <span>fhd_basic.sh</span> script. 
                    First, this is an
                     <a href="https://docs.ccv.brown.edu/oscar/submitting-jobs/array" target="_blank"> <i>array</i> job </a>, 
                     which you can see from the <span>#SBATCH --array=0-2</span> line. This means that this script is 
                     submitting <i>three</i> jobs to SLURM, one for every integer in the range 0-2 (2 included).
                </p>

                <p>
                    We can use this to our advantage. The <span>SLURM_ARRAY_TASK_ID</span> automatically records the 
                    array ID, and since we can pass that as an argument to <span>idl</span>, we are effectively running the 
                    <span>fhd_single_uvfits</span> procedure on all three files located in the specified data path.
                </p>

                <p>
                    If you're wondering what's up with the <span>while</span> loop, that's there because we only have a 
                    limited number of active IDL licenses (around 24 as of Feb. 2026). One job on SLURM = one IDL license 
                    required (I know, what a scam). The <span>while</span> loop is there as a safeguard in case you or a group member 
                    already has a lot of active IDL jobs: it tells the script to keep retrying until it is able to acquire a license.
                </p>

                <p>
                    If you need to submit way more than ~24 jobs (let's say you need to run <span>FHD</span> on 300 
                    observations) and you're worried about filling up the queue, you can limit the number of simultaneous 
                    array jobs using a hashtag; e.g. <span>#SBATCH --array=0-299%20</span>. This will run your 300 jobs, 
                    but only allow 20 at a time, freeing up the queue for other group members and making sure you don't use up 
                    all the IDL licenses.
                </p>

                <p>
                    To try out this advanced FHD run, simply  <span>cd</span> 
                    into the <span>fhd_eppsilon/shell_scripts</span> directory and run:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
[fhd_eppsilon/shell_scripts]$ sbatch fhd_advanced.sh
                    </code></pre>
                </div>



                <h2 id="integrate">FHD - Cube Integration</h2>


                <p>
                    A successful <span>FHD</span> run will produce a <i>ton</i> of output 
                    files. For example, the <span>fhd_advanced</span> example from the previous 
                    section would populate an <span>fhd_advanced</span> directory located in
                     <span>/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs</span>:
                </p>

                <ul class="list-unstyled tree-ul">
                    fhd_advanced
                    <ul class="list-unstyled tree-ul">
                        <li>beams</li>
                        <li>calibration</li>
                        <li>grid_data</li>
                        <li>Healpix</li>
                        <li>mapfn</li>
                        <li>metadata</li>
                        <li>output_data</li>
                        <li>output_images</li>
                        <li>vis_data</li>
                    </ul>
                </ul>

                <p>
                    I won't go into detail as to what all these subdirectories contain (please refer to the 
                    <a href="https://github.com/EoRImaging/FHD" target="_blank"><span>FHD</span> documentation</a>), 
                    but I will mention a few important things.
                </p>

                <ul>
                    <li> 
                        The <span>output_images</span> folder is your most important diagnostic tool. It contains several 
                        PNGs showing the calibration amplitude, the dirty image, the model image, the UV weights, and so on. 
                        You should always take a look at these outputs to understand what (if anything) went wrong during 
                        your <span>FHD</span> run.
                    </li>
                    <li>
                        The <span>Healpix</span> folder contains your ultimate data product. If you open it, you should find 
                        four so-called "Healpix cubes" for <i>each</i> observation; e.g: 

                        <ul class="list-unstyled tree-ul">
                            Healpix
                            <ul class="list-unstyled tree-ul">
                                <li>1160572216_even_cubeXX.sav</li>
                                <li>1160572216_even_cubeYY.sav</li>
                                <li>1160572216_odd_cubeXX.sav</li>
                                <li>1160572216_odd_cubeYY.sav</li>
                            </ul>
                        </ul>

                        If you are wondering what are "Healpix cubes", why you get four of them out of each observation, and why they are 
                        split into "odd", "even", "XX", and "YY", I invite you to consult 
                        <a href="https://www.cambridge.org/core/journals/publications-of-the-astronomical-society-of-australia/article/fhdppsilon-epoch-of-reionisation-power-spectrum-pipeline/DBD9EF23A17F4646A98630176775EE2E" target="_blank">Barry et al. 2019</a>.
                    </li>
                </ul>

                <p>
                    In order to get a power spectrum out of your, say, hundreds of observations, their output <span>Healpix</span> 
                    cubes need to be <i>integrated</i> together. This means you need to take the hundreds of 
                    <span>{obsid}_even_cubeXX.sav</span>, <span>{obsid}_even_cubeYY.sav</span>, 
                    <span>{obsid}_odd_cubeXX.sav</span>, <span>{obsid}_odd_cubeYY.sav</span> 
                    files, and combine them into four final cubes.
                </p>

                <p>
                    Before going into the details, let's take a look at the relevant directory tree for this section. Still 
                    working off of the top-level tree in <span>/oscar/data/jpober/shared/Tutorials/fhd_eppsilon</span>:
                </p>

                <ul class="list-unstyled tree-ul">
                    <li>
                        data
                        <ul class="list-unstyled tree-ul">
                            <li>integration_lists</li>
                            <ul class="list-unstyled tree-ul">
                                <li>fhd_advanced_evenXX_list.txt</li>
                                <li>fhd_advanced_evenYY_list.txt</li>
                                <li>fhd_advanced_oddXX_list.txt</li>
                                <li>fhd_advanced_oddYY_list.txt</li>
                            </ul>
                        </ul>
                    </li>
                    <li>
                        fhd_outputs
                        <ul class="list-unstyled tree-ul">
                            <li>fhd_advanced</li>
                        </ul>
                    </li>
                    <li>
                        idl_wrappers
                        <ul class="list-unstyled tree-ul">
                            <li>integrate_cubes.pro</li>
                        </ul>
                    </li>
                    <li>
                        shell_scripts
                        <ul class="list-unstyled tree-ul">
                            <li>integration_scripts</li>
                            <ul class="list-unstyled tree-ul">
                                <li>fhd_advanced_integrate_even_cubeXX.sh</li>
                                <li>fhd_advanced_integrate_even_cubeYY.sh</li>
                                <li>fhd_advanced_integrate_odd_cubeXX.sh</li>
                                <li>fhd_advanced_integrate_odd_cubeYY.sh</li>
                            </ul>
                        </ul>
                    </li>
                    <li>
                        slurm_out
                    </li>
                </ul>

                <p>
                    Let's unpack this section one element at a time. First, let's take a look at the 
                    <span>integrate_cubes.pro</span> procedure:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">idl</div>
                    <pre class="custom-code"><code class="language-autoit">
pro integrate_cubes

    compile_opt strictarr

    ;-- Read command-line arguments
    args = Command_Line_Args(count=nargs)
    filenames        = args[0]
    save_file        = args[1]

    integrate_healpix_cubes, filenames, save_file=save_file

end
                    </code></pre>
                </div>

                <p>
                    As you can see, this is a very simple procedure. All it needs is a list of files to integrate, and 
                    an output file name.
                </p>

                <p>
                    The <span>filenames</span> argument should point to a <span>.txt</span> file containing the 
                    paths to all the <span>Healpix</span> cubes you wish to integrate. <b>NOTE:</b> the integration 
                    has to be done for all four combinations (even/odd/XX/YY) <i>separately</i>.
                </p>

                <p>
                    As an example, if I have a bunch of <span>{obs}_even_cube_XX.sav</span> files I want to integrate, 
                    I need to create a <span>.txt</span> file that points to each of them. For example, we may 
                    wish to integrate the output cubes from our <span>fhd_advanced</span> run from earlier. The 
                    corresponding integration list for the <span>even_cubeXX</span> cubes (which is found in 
                    <span>data/integration_lists/fhd_advanced_evenXX_list.txt</span>) should look like:
                </p>

                 <div class="code-container mt-2">
                    <div class="code-header">plaintext</div>
                    <pre class="custom-code"><code class="language-plaintext">
/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/fhd_advanced/Healpix/1160573184_even_cubeXX.sav
/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/fhd_advanced/Healpix/1161092368_even_cubeXX.sav
/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/fhd_advanced/Healpix/1161700008_even_cubeXX.sav
                    </code></pre>
                </div>

                <p>
                    Similarly, you should create a plain text file for the other three combinations (even-YY, odd-XX, odd-YY).
                    You can automate the <span>.txt</span> file creation via Python.
                </p>


                <p>
                    Each integration list requires its own shell script to submit a job to SLURM. Here's an example for the 
                    even-XX combination (in <span>shell_scripts/integration_scripts/fhd_advanced_integrate_even_cubeXX.sh</span>):
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">bash</div>
                    <pre class="custom-code"><code class="language-bash">
#!/bin/bash

#SBATCH -J fhd_advanced_integrate_even_cubeXX
#SBATCH -c 12
#SBATCH --mem=200G
#SBATCH --time=48:00:00
#SBATCH -o /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_advanced_integrate_even_cubeXX-%j.out
#SBATCH -e /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/fhd_advanced_integrate_even_cubeXX-%j.out
#SBATCH --account=jpober-condo

module load imagemagick
module load idl

retry_delay=300  # seconds

while true; do
    echo "Attempting to start IDL..."
    output=$( idl \
        -IDL_DEVICE ps \
        -quiet \
        -IDL_CPU_TPOOL_NTHREADS 12 \
        -e integrate_cubes \
        -args '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/data/integration_lists/fhd_advanced_evenXX_list.txt' '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/fhd_advanced/Healpix/Combined_obs_even_cubeXX.sav' \
        2>&1 )
        
    status=$?
    echo "$output"

    if echo "$output" | grep -q "Failed to acquire license"; then
        echo "IDL license unavailable. Retrying in $retry_delay seconds..."
        sleep $retry_delay
    elif [ $status -eq 0 ]; then
        echo "IDL ran successfully."
        break
    else
        echo "IDL exited with an error (status $status)."
        break
    fi
done
                    </code></pre>
                </div>



                <p>
                    To launch this integration job, <span>cd</span> 
                    into the <span>fhd_eppsilon/shell_scripts/integration_scripts</span> subdirectory and run:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
[integration_scripts]$ sbatch fhd_advanced_integrate_even_cubeXX.sh
                    </code></pre>
                </div>


                <p>
                    As mentioned earlier, you will need to run a separate SLURM job for all four even/odd/XX/YY combinations. 
                    Once this is done, four "combined" Healpix cubes will appear in your 
                     <span>fhd_outputs/fhd_advanced/Healpix</span> directory, ready to pass to <span>eppsilon</span> for 
                     the final power spectrum.
                </p>




                <h2 id="eppsilon">eppsilon</h2>

                <p>
                    <span>eppsilon</span>, which stands for "error propagated power spectrum with interleaved observed noise", 
                    is a package to calculate 21 cm power spectra and associated error bars and metrics from 3D image cubes. You 
                    can view the official documentation 
                    <a href="https://github.com/EoRImaging/eppsilon" target="_blank">here</a>. For a more detailed introdution 
                    to the <span>FHD/eppsilon</span> pipeline, I invite you to consult 
                    <a href="https://www.cambridge.org/core/journals/publications-of-the-astronomical-society-of-australia/article/fhdppsilon-epoch-of-reionisation-power-spectrum-pipeline/DBD9EF23A17F4646A98630176775EE2E" target="_blank">Barry et al. 2019</a>.
                </p>

                <p>
                    The purpose of <span>eppsilon</span> is to take the <span>Healpix</span> cubes you generated 
                    using <span>FHD</span>, and generate a power spectrum out of them. By default, 
                    <span>eppsilon</span> knows to search for the default filenaming convention for all the 
                    even/odd/XX/YY combinations, so all you have to specify is whatever is prepended to that file 
                    name. In practice, this means you either want to specify the <i>obsid</i> (to produce a 
                    power spectrum from a single observation), or you want to specify <i><span>Combined_obs</span></i> (to 
                    produce a power spectrum from the integrated cubes spanning multiple observations).
                </p>

                <p>
                    Let's look at the relevant directory tree for this section.
                </p>

                <ul class="list-unstyled tree-ul">
                    <li>
                        data
                    </li>
                    <li>
                        fhd_outputs
                        <ul class="list-unstyled tree-ul">
                            <li>fhd_advanced
                                <ul class="list-unstyled tree-ul">
                                    <li>Healpix
                                        <ul class="list-unstyled tree-ul">
                                            <li>1160573184_even_cubeXX.sav</li>
                                            <li>1160573184_even_cubeYY.sav</li>
                                            <li>1160573184_odd_cubeXX.sav</li>
                                            <li>1160573184_odd_cubeYY.sav</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li>
                        idl_wrappers
                        <ul class="list-unstyled tree-ul">
                            <li>eppsilon_basic.pro</li>
                        </ul>
                    </li>
                    <li>
                        shell_scripts
                        <ul class="list-unstyled tree-ul">
                            <li>eppsilon_basic.sh</li>
                        </ul>
                    </li>
                    <li>
                        slurm_out
                    </li>
                </ul>

                <p>
                    Opening up the <span>eppsilon_basic.pro</span> procedure:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">idl</div>
                    <pre class="custom-code"><code class="language-autoit">
pro eppsilon_basic

    ;-- Read-in parameters from the command line
    compile_opt strictarr
    args = Command_Line_Args(count=nargs)
    folder_name=args[0]
    obs_range=args[1]

    print,'folder_name = '+folder_name
    print,'obs_range = '+obs_range

    ;-- Custom keywords here
    png               = 1 
    exact_obsnames    = 1
    refresh_binning   = 1
    refresh_ps        = 1
    refresh_dft       = 1

    ;-- Bundle variables defined in this wrapper
    extra = var_bundle()

    ;-- Launch the main power spectrum procedure
    ps_wrapper, folder_name, obs_range, _extra=extra

end
                    </code></pre>
                </div>

                <p>
                    Again, very simple. It reads in a folder name and an "obs_range" keyword from the top-level 
                    script, and passes those down to the <span>ps_wrapper</span> procedure. The "obs_range" 
                    keyword lets you specify the string that is prepended to your <span>_even_cubeXX</span> (and all 
                    other combinations). I think it actually searches for all items in the <span>Healpix</span> folder 
                    containing that string, and runs the job on all of them (but I've only ever used it on one set of 
                    cubes at a time, so I could be wrong).
                </p>

                <p>
                    Next, let's take a look at the top-level script that calls this procedure, <span>eppsilon_basic.sh</span>:
                </p>


                <div class="code-container mt-2">
                    <div class="code-header">bash</div>
                    <pre class="custom-code"><code class="language-bash">
#!/bin/bash

#SBATCH -J eppsilon_basic
#SBATCH -c 12
#SBATCH --mem=64G
#SBATCH --time=24:00:00
#SBATCH -o /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/eppsilon_basic.out
#SBATCH -e /oscar/data/jpober/shared/Tutorials/fhd_eppsilon/slurm_out/eppsilon_basic.out
#SBATCH --account=jpober-condo

module load imagemagick
module load idl

retry_delay=300  # seconds

while true; do
    echo "Attempting to start IDL..."
    output=$( idl \
        -IDL_DEVICE ps \
        -quiet \
        -IDL_CPU_TPOOL_NTHREADS 12 \
        -e eppsilon_custom \
        -args '/oscar/data/jpober/shared/Tutorials/fhd_eppsilon/fhd_outputs/fhd_advanced/' '1160573184' \
        2>&1 )
        
    status=$?
    echo "$output"

    if echo "$output" | grep -q "Failed to acquire license"; then
        echo "IDL license unavailable. Retrying in $retry_delay seconds..."
        sleep $retry_delay
    elif [ $status -eq 0 ]; then
        echo "IDL ran successfully."
        break
    else
        echo "IDL exited with an error (status $status)."
        break
    fi
done
                    </code></pre>
                </div>

                <p>
                    Here, we are specifying via <span>-args</span> to <i>only</i> run <span>eppsilon</span> on 
                    the cubes with observation ID 1160573184 (which I've outlined in the 
                    directory tree above). To run a power spectrum on the <i>combined</i> cubes, 
                    we would specify <span>Combined_obs</span> instead of <span>1160573184</span> in the arguments.
                </p>

                <p>
                    As always, to launch this job,  <span>cd</span> 
                    into the <span>fhd_eppsilon/shell_scripts</span> directory and run:
                </p>

                <div class="code-container mt-2">
                    <div class="code-header">shell</div>
                    <pre class="custom-code"><code class="language-shell">
[fhd_eppsilon/shell_scripts]$ sbatch eppsilon_basic.sh
                    </code></pre>
                </div>


                <h2 id="eppsilon-outputs">eppsilon Outputs</h2>

                <p>
                    A successful <span>eppsilon</span> job will create a new folder in the 
                    <span>fhd_outputs/fhd_advanced</span> directory:
                </p>


                <ul class="list-unstyled tree-ul">
                    <li>
                        fhd_advanced
                        <ul class="list-unstyled tree-ul">
                            <li>...</li>
                            <li>ps
                                <ul class="list-unstyled tree-ul">
                                    <li>data</li>
                                    <li>plots
                                        <ul class="list-unstyled tree-ul">
                                            <li>1d_binning</li>
                                            <li>2d_binning</li>
                                            <li>...</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>...</li>
                        </ul>
                    </li>
                </ul>

                <p>
                    I'm using ... here to indicate that there are a <i>lot</i> more files and folders than this, 
                    but the ones I'm explicitly writing out here are the most important. Specifically, the 
                    <span>plots/1d_binning</span> and <span>plots/2d_binning</span> contain your ultimate 
                    power spectrum data products.
                </p>


                
                <div class="d-flex justify-content-between">
                    <p class="last-edit">Last edit: 2026-02-08</p>
                    <p class="last-edit">Author: Jade Ducharme</p>
                </div>

            </div>
            
            <div class="d-none d-lg-block col-lg-3"></div>
            </div>
        </div>
    </div>
    
    
</body>

<div id="footer-template"></div> <!-- Footer loads here -->

</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/bash.min.js" integrity="sha512-nQ9BQEzuov+Ry6EIH8ve7VKKdOG91Ix3SAQcFmOiBR5qG8sJONrph1InWTJOGjfP5QkSTSy4VnkEsPMoFYRsUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/shell.min.js" integrity="sha512-W4zfUSnG/iue7LUx5hV2wF+akM0hVh4afLk8Avl3reONnH2lF5wPrg/D0rMGWHgZE2d+4XTjG5EJWzkyegUd5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/autoit.min.js" integrity="sha512-IPjYZ/J8t6x31d/SARbULBpe6IjG7MbV51kipvGfCb8Lepy33XHEgerqSA5+HsBfCeLKT35oAPndgo6p2AzooQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="assets/js/load-templates.js"></script>
<script src="assets/js/copy-code.js"></script>
<script src="assets/js/page-navigation-buttons.js"></script>
